version: '3'
services:
  n4j-flask:
    build:
      context: app
      dockerfile: Dockerfile
    container_name: n4j-flask
    image: n4j-flask
    restart: unless-stopped
    environment:
      FLASK_ENV: "prod"
      FLASK_DEBUG: 0
      APP_PORT: 5000
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: test
    volumes:
      - ./app:/var/www
    command: gunicorn -w 4 --bind=0.0.0.0:5000 "flaskr:create_app()"
    depends_on:
      - n4j-db
    networks:
      - n4j-frontend
      - n4j-backend

  n4j-db:
    image: neo4j:3.5
    container_name: n4j-db
    restart: unless-stopped
    ports:
      - 7474:7474
      - 7687:7687
    volumes:
      # - ./conf:/conf
      # - ./data:/data
      # - ./import:/import
      # - ./logs:/logs
      # - ./plugins:/plugins
      - neo4jdata:/conf
      - neo4jdata:/data
      - neo4jdata:/import
      - neo4jdata:/logs
      - neo4jdata:/plugins
    environment: 
      - NEO4J_AUTH=neo4j/test
      # Raise memory limits
      - NEO4J_dbms_memory_pagecache_size=1G
      - NEO4J_dbms.memory.heap.initial_size=1G
      - NEO4J_dbms_memory_heap_max__size=1G
    networks:
      - n4j-backend

  n4j-webserver:
    build:
      context: nginx
      dockerfile: Dockerfile
    image: n4j-webserver
    container_name: n4j-webserver
    restart: unless-stopped
    environment:
      APP_ENV: "prod"
      APP_NAME: "webserver"
      APP_DEBUG: "true"
      SERVICE_NAME: "webserver"
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - nginxdata:/var/log/nginx
    depends_on:
      - n4j-flask
    networks:
      - n4j-frontend

networks:
  n4j-frontend:
    driver: bridge
  n4j-backend:
    driver: bridge

volumes:
  neo4jdata:
    driver: local
  # appdata:
    # driver: local
  nginxdata:
    driver: local
